# [v0.0.12]_FIXES_TPVAVANZADO_PERSISTENCIA_INCONSISTENTE_EN_COMANDAS_PENDIENTE.md

## Problema Detectado

La persistencia de comandas en el TPV Avanzado no es consistente: al cerrar y volver a abrir la ventana de TPVAvanzado para una mesa, la lista de productos del pedido vuelve a estar vacía, aunque la comanda existe en la base de datos. Esto afecta la experiencia de usuario y la integridad de los datos.

## Síntomas
- Al crear una comanda y añadir productos, todo funciona correctamente.
- Al cerrar la ventana de TPVAvanzado y volver a abrirla para la misma mesa, la comanda aparece vacía (sin productos), aunque la cabecera de la comanda existe en la base de datos.
- Los cambios de estado de la comanda (por ejemplo, a 'en_proceso') sí se persisten, pero las líneas/productos no se recuperan.
- No hay errores SQL en la recuperación tras corregir los nombres de columnas, pero la caché y la recuperación de líneas siguen sin funcionar.

## Hipótesis y Áreas a Investigar
1. **Carga de productos en la inicialización:**
   - Verificar si la función que recupera la comanda activa realmente carga las líneas/productos desde la base de datos y los asigna correctamente al objeto Comanda.
2. **Persistencia de líneas:**
   - Confirmar que al agregar/eliminar productos, las líneas se insertan/actualizan correctamente en la tabla `comanda_detalles`.
3. **Caché y sincronización:**
   - Analizar si la caché de comandas (`_comandas_cache`) se sincroniza correctamente tras operaciones de persistencia y recuperación.
4. **Inicialización de TPVService:**
   - Revisar si al crear una nueva instancia de TPVService (o al reiniciar la app), se cargan todas las comandas y líneas activas desde la base de datos.
5. **Flujo de UI:**
   - Asegurar que la UI de TPVAvanzado refresca correctamente la tabla de productos al asignar una comanda recuperada.
6. **Integridad de datos:**
   - Verificar que no hay triggers, constraints o errores silenciosos en la base de datos que impidan la inserción/recuperación de líneas.

## Plan de Acción

1. **Auditoría de la función de carga de comandas:**
   - Revisar `_load_comandas_from_db` y `get_comanda_activa` para asegurar que las líneas se cargan y asignan correctamente.
   - Añadir logs detallados para verificar el contenido de las líneas tras la carga.
2. **Verificación de persistencia de líneas:**
   - Auditar `persistir_comanda` y los métodos de inserción en `db_manager` para asegurar que las líneas se guardan realmente en la tabla `comanda_detalles`.
   - Probar manualmente y con SQL directo si los datos existen tras agregar productos.
3. **Revisión de la caché:**
   - Confirmar que la caché se actualiza tras cada operación y que no se sobrescribe con objetos vacíos.
   - Añadir logs para el ciclo de vida de la caché de comandas.
4. **Pruebas de recuperación tras reinicio:**
   - Simular el cierre y reapertura de la app, y verificar si la carga inicial de comandas y líneas es correcta.
5. **Validación de la UI:**
   - Revisar el flujo de refresco de la tabla de productos en TPVAvanzado al asignar una comanda recuperada.
   - Añadir logs en la UI para confirmar la recepción de datos.
6. **Revisión de la base de datos:**
   - Consultar directamente la tabla `comanda_detalles` para confirmar la existencia de líneas tras operaciones de alta/modificación.
   - Verificar integridad y constraints.

## Próximos Pasos
- Ejecutar el plan de acción punto por punto, documentando hallazgos y cambios.
- Registrar cualquier excepción funcional encontrada y dejar TODOs en el código si es necesario.
- Actualizar este documento con los resultados y la solución definitiva.

---

**Responsable:** Equipo de desarrollo Hefest
**Fecha:** 2025-07-08
**Estado:** PENDIENTE

> Este documento debe actualizarse tras cada avance relevante y al cerrar el fix.
