# [v0.0.12]_FIX_SERVICES_OrdenCommitAntesDeEmitirEvento_RESUELTO.md

## üõ†Ô∏è FIX: Orden correcto de commit y emisi√≥n de eventos en cancelaci√≥n de reservas

**Versi√≥n:** v0.0.12  
**√Årea:** services / reservas_agenda / sincronizaci√≥n TPV  
**Estado:** RESUELTO  
**Fecha:** 2025-07-09

---

### üîç Descripci√≥n del problema

Al cancelar una reserva, la se√±al/evento para refrescar la UI de mesas (`mesa_actualizada`) se emit√≠a **antes** de realizar el commit de la transacci√≥n en la base de datos. Esto provocaba que la UI consultara el estado de la mesa y de las reservas activas antes de que la base de datos y la cach√© estuvieran actualizadas, generando desfases visuales donde la mesa segu√≠a apareciendo como "reservada" tras cancelar la reserva.

---

### ‚úÖ Soluci√≥n aplicada

- Se reorden√≥ la l√≥gica en `cancelar_reserva` (`reserva_service.py`) para que el `conn.commit()` se ejecute **antes** de emitir cualquier se√±al/evento.
- Ahora, tras actualizar el estado de la reserva y la mesa en la base de datos:
  1. Se realiza el commit de la transacci√≥n.
  2. Se actualiza/invalida la cach√© de reservas activas (si aplica).
  3. **Solo despu√©s** se emite la se√±al/evento `mesa_actualizada` para refresco inmediato de la UI.
- Esto garantiza que cualquier consulta posterior a la se√±al refleje el estado real y actualizado.

---

### üß© C√≥digo relevante (extracto)

```python
# Antes (incorrecto):
# ...
if mesa_obj is not None:
    mesa_event_bus.mesa_actualizada.emit(mesa_obj)
conn.commit()

# Despu√©s (correcto):
# ...
conn.commit()
if mesa_obj is not None:
    mesa_event_bus.mesa_actualizada.emit(mesa_obj)
```

---

### üìù Notas y validaci√≥n
- Se valid√≥ por logs y pruebas manuales que la mesa pasa a estado "libre" inmediatamente tras cancelar la reserva, sin desfases ni parpadeos.
- No se detectan condiciones de carrera ni inconsistencias tras el cambio.

---

### üìÖ Registro de cumplimiento
- Cumple con la pol√≠tica de orden y atomicidad de operaciones cr√≠ticas.
- Documentado seg√∫n la nomenclatura y estructura del proyecto.

---

@hefest-devs  
