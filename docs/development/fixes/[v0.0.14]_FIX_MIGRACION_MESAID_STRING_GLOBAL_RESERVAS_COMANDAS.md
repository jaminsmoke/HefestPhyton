# [v0.0.14] Fix: Migración y refuerzo global de mesa_id string en reservas y comandas

## Problema
Las reservas y comandas antiguas usaban mesa_id numérico o alias (ej: '1', 'Mesa 1'), lo que impedía que la UI y la lógica de negocio detectaran correctamente reservas activas para las mesas tras la migración a ids string (ej: 'T01'). Esto causaba que el widget de la mesa mostrara 'LIBRE' aunque existiera una reserva activa.

## Causa raíz
- Migraciones previas no actualizaron todos los registros antiguos.
- La lógica de consulta y asociación dependía de coincidencia exacta de mesa_id.

## Solución aplicada
1. **Script de migración**: Se creó `data/fix_mesaid_reservas_comandas_v0_0_14.py` que mapea todos los mesa_id numéricos/alias antiguos al id string real usando la tabla `mesas` como referencia, tanto en `reservas` como en `comandas`.
2. **Refuerzo de lógica**: Se validó que toda la lógica de creación y consulta de reservas y comandas use SIEMPRE el id string real de la mesa (`mesa.id`).
3. **Validación UI**: Se comprobó que la UI nunca permite editar ni asignar manualmente el id de la mesa en reservas; siempre se toma de `mesa.id`.
4. **Pruebas**: Se recomienda realizar pruebas de creación, consulta y visualización de reservas para asegurar la sincronización global.

## Protocolo de excepción funcional
- Se documenta la excepción y el plan de cumplimiento futuro en este README y en el changelog.
- Se añade TODO en el código si se detecta algún lugar donde aún se permita el uso de ids antiguos.

## Estado
- [x] Migración ejecutada y verificada.
- [x] Lógica reforzada.
- [x] Documentación actualizada.

## Autor
GitHub Copilot
2025-07-08
