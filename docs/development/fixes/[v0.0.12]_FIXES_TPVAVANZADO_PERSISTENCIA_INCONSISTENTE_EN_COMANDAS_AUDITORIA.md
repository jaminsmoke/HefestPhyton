# [v0.0.12]_FIXES_TPVAVANZADO_PERSISTENCIA_INCONSISTENTE_EN_COMANDAS_AUDITORIA.md

## Auditoría y Ejecución del Plan de Acción

### 1. Auditoría de la función de carga de comandas
- `_load_comandas_from_db` y `get_comanda_activa`:
  - Ambas funciones consultan la base de datos y reconstruyen las líneas de la comanda a partir de la tabla `comanda_detalles`.
  - Se ha verificado que el mapeo de columnas (`producto_id`, `cantidad`, `precio_unitario`) es correcto y que se instancia `LineaComanda` con estos datos.
  - **Acción:** Añadir logs detallados tras la carga de líneas para auditar el contenido real recuperado.

### 2. Verificación de persistencia de líneas
- `persistir_comanda`:
  - Borra todas las líneas previas de la comanda y vuelve a insertar las actuales en `comanda_detalles`.
  - Utiliza el método `insert` de `db_manager`, que ejecuta un `INSERT INTO` estándar.
  - **Acción:** Añadir logs tras la inserción y consultar manualmente la tabla para confirmar la existencia de líneas.

### 3. Revisión de la caché
- La caché `_comandas_cache` se actualiza tras cada recuperación o persistencia.
- **Acción:** Añadir logs para el ciclo de vida de la caché y verificar que no se sobrescriben objetos vacíos.

### 4. Pruebas de recuperación tras reinicio
- Simular cierre y reapertura de la app, verificando que la carga inicial de comandas y líneas es correcta.
- **Acción:** Añadir logs en la inicialización y comparar con el contenido real de la base de datos.

### 5. Validación de la UI
- Revisar el flujo de refresco de la tabla de productos en TPVAvanzado al asignar una comanda recuperada.
- **Acción:** Añadir logs en la UI para confirmar la recepción de datos.

### 6. Revisión directa de la base de datos
- Consultar la tabla `comanda_detalles` tras operaciones de alta/modificación para confirmar la existencia de líneas.
- **Acción:** Usar SQL directo o herramientas de inspección para validar la integridad.

---

## Resultados de la Auditoría (2025-07-08)

### Ejecución y observaciones
- Tras instrumentar el código con logs de auditoría, se reinició la aplicación y se accedió al módulo TPVAvanzado.
- El log muestra:
  - Se detecta correctamente la existencia de una comanda activa para la mesa 1 (`Mesa 1 - Comanda 1`).
  - **Sin embargo, las líneas recuperadas para la comanda están vacías:**
    - `[AUDITORÍA] Mesa 1 - Comanda 1 - Líneas recuperadas: []`
    - El estado final de la caché también refleja líneas vacías.
- No se observan errores SQL ni excepciones en la carga.
- El flujo de inicialización y refresco de la UI ocurre correctamente, pero la tabla de productos permanece vacía.

### Diagnóstico
- **La cabecera de la comanda existe en la base de datos, pero no hay líneas asociadas en `comanda_detalles` para esa comanda.**
- Esto confirma que el problema de fondo es de persistencia real: las líneas no se están guardando o se han perdido en algún punto del flujo.
- La lógica de recuperación funciona, pero no hay datos que recuperar.

### Próximos pasos inmediatos
1. Auditar el flujo de alta y modificación de productos en la comanda para asegurar que `persistir_comanda` se llama correctamente y que realmente se insertan líneas en la tabla.
2. Realizar una prueba manual: crear una comanda, añadir productos, y consultar la tabla `comanda_detalles` directamente tras la operación.
3. Si tras añadir productos la tabla sigue vacía, revisar posibles errores en la llamada a `insert` o en la transacción.
4. Documentar el resultado de la prueba manual y, si es necesario, instrumentar aún más el flujo de inserción.

**Estado:** EN INVESTIGACIÓN (persistencia de líneas)

---

## Protocolo de Prueba Manual: Persistencia de Líneas en Comanda

### Objetivo
Verificar que, al añadir productos a una comanda desde la UI del TPVAvanzado, las líneas se persisten correctamente en la tabla `comanda_detalles` de la base de datos.

### Pasos
1. Iniciar la aplicación y acceder al módulo TPVAvanzado.
2. Seleccionar una mesa sin comanda activa o crear una nueva comanda.
3. Añadir uno o varios productos a la comanda desde la UI.
4. Confirmar visualmente que los productos aparecen en la tabla de productos de la UI.
5. Consultar la tabla `comanda_detalles` directamente en la base de datos (por ejemplo, usando DB Browser for SQLite o un script SQL):
   - `SELECT * FROM comanda_detalles WHERE comanda_id = <id_de_la_comanda>;`
6. Registrar si las líneas añadidas aparecen correctamente en la tabla.
7. Cerrar y volver a abrir la ventana de TPVAvanzado para la misma mesa y verificar si los productos se recuperan.

### Resultado de la prueba
- [ ] Las líneas de productos aparecen en la tabla `comanda_detalles` tras la inserción.
- [ ] La recuperación de la comanda muestra los productos correctamente en la UI tras reiniciar la ventana.
- [ ] Si alguna de las condiciones anteriores falla, anotar logs, mensajes de error y observaciones.

#### Observaciones y logs:

- Consulta a `comandas`:
  - id: 1
  - mesa_id: 1 (pero los ids reales de mesa siguen la nomenclatura 'T01', no enteros)
  - usuario_id: 1
  - fecha_hora: 2025-07-07 23:26:14
  - estado: en_proceso
  - total: 0
- Consulta a `comanda_detalles`:
  - Sin resultados (vacío)
- En la UI de TPVAvanzado aparecen productos en la lista, pero no se persisten en la base de datos.

##### Diagnóstico adicional:
- Existe un posible **problema de correspondencia de IDs de mesa**: la tabla `comandas` guarda `mesa_id` como entero (1), pero las mesas reales usan identificadores tipo 'T01'.
- Esto puede provocar que la lógica de recuperación y persistencia no asocie correctamente las comandas con las mesas reales, y que la UI muestre productos en memoria pero no los persista ni recupere correctamente.

---

## Plan de Refactor: Unificación de Identificador de Mesa (string)

### Objetivo
Asegurar que el identificador de mesa (`mesa_id`) sea siempre un string (ej: 'T01') en toda la lógica, modelos y base de datos, eliminando inconsistencias y garantizando la persistencia y recuperación correcta de comandas y líneas.

### Pasos concretos
1. **Auditoría de modelos y base de datos:**
   - Revisar el modelo `Mesa` y cambiar `id: int` a `id: str` si es necesario.
   - Revisar el modelo `Comanda` y cambiar `mesa_id: int` a `mesa_id: str`.
   - Revisar la definición de la tabla `comandas` y migrar el campo `mesa_id` a tipo `TEXT`.
2. **Migración de datos:**
   - Crear un script de migración SQL para convertir los valores de `mesa_id` en la tabla `comandas` a los identificadores string reales de las mesas (por ejemplo, de 1 a 'T01').
   - Actualizar cualquier referencia en `comanda_detalles` si fuera necesario.
3. **Refactor de lógica de negocio:**
   - Modificar toda la lógica de creación, persistencia y recuperación de comandas para usar siempre el identificador string de la mesa.
   - Actualizar los métodos de búsqueda y caché (`_comandas_cache`, etc.) para indexar por string.
   - Revisar la UI y widgets para que siempre pasen y reciban el identificador string.
4. **Pruebas y validación:**
   - Probar la creación, persistencia y recuperación de comandas y líneas con el nuevo esquema.
   - Validar que la UI muestra y recupera correctamente los productos tras reinicios y cambios de ventana.
   - Ejecutar auditoría SQL para confirmar la integridad de los datos.
5. **Documentación y comunicación:**
   - Documentar el cambio en el changelog y en los fixes.
   - Comunicar al equipo la nueva convención de uso de identificadores de mesa.

### Advertencias
- Este cambio es **crítico** y puede afectar toda la lógica de TPV, reservas y módulos relacionados.
- Realizar backup completo de la base de datos antes de aplicar la migración.
- Revisar y actualizar todos los tests automáticos y manuales.

---

## Hallazgos Iniciales y Próximos Pasos
- El código de persistencia y recuperación parece correcto a nivel de lógica, pero se requieren logs y validaciones directas para descartar problemas de concurrencia, caché o UI.
- Se documentarán los resultados de cada acción y se actualizará el fix principal.

**Responsable:** Equipo de desarrollo Hefest
**Fecha:** 2025-07-08
**Estado:** EN AUDITORÍA

> Este documento se irá completando conforme se ejecuten y validen los pasos del plan de acción.
